<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown编辑保存测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    .test-section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    button {
      padding: 8px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 3px;
      font-family: monospace;
      font-size: 14px;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .success {
      color: green;
    }
    .error {
      color: red;
    }
    .info {
      color: blue;
    }
    .counter {
      display: inline-block;
      margin-left: 10px;
      padding: 5px 10px;
      background-color: #e9ecef;
      border-radius: 3px;
      font-weight: bold;
    }
    #markdownEditor {
      border: 1px solid #ddd;
      border-radius: 3px;
      min-height: 200px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .test-progress {
      margin-top: 10px;
      padding: 10px;
      background-color: #e9ecef;
      border-radius: 3px;
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #f8f9fa;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-fill {
      height: 100%;
      background-color: #007bff;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
    input[type="file"] {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Markdown编辑保存测试</h1>
  
  <div class="test-section">
    <h2>1. 测试配置</h2>
    <label>
      <input type="checkbox" id="includeImages" checked>
      包含图片上传
    </label>
    <br>
    <label>
      <input type="file" id="testImage" accept="image/*">
      测试图片
    </label>
    <br>
    <label>
      测试次数: <input type="number" id="testCount" value="10" min="1" max="100">
    </label>
    <br>
    <label>
      操作间隔(ms): <input type="number" id="interval" value="1000" min="100" max="5000">
    </label>
  </div>
  
  <div class="test-section">
    <h2>2. 测试操作</h2>
    <button id="startTest">开始测试</button>
    <button id="stopTest" disabled>停止测试</button>
    <button id="clearResult">清空结果</button>
    <div class="counter">
      成功: <span id="successCount">0</span> | 失败: <span id="errorCount">0</span> | 总次数: <span id="totalCount">0</span>
    </div>
  </div>
  
  <div class="test-section">
    <h2>3. 测试进度</h2>
    <div class="test-progress">
      <div id="progressText">准备开始测试...</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>
  </div>
  
  <div class="test-section">
    <h2>4. 测试结果</h2>
    <div id="result" class="result"></div>
  </div>

  <script>
    // DOM元素
    const includeImages = document.getElementById('includeImages');
    const testImage = document.getElementById('testImage');
    const testCount = document.getElementById('testCount');
    const interval = document.getElementById('interval');
    const startTest = document.getElementById('startTest');
    const stopTest = document.getElementById('stopTest');
    const clearResult = document.getElementById('clearResult');
    const result = document.getElementById('result');
    const successCount = document.getElementById('successCount');
    const errorCount = document.getElementById('errorCount');
    const totalCount = document.getElementById('totalCount');
    const progressText = document.getElementById('progressText');
    const progressFill = document.getElementById('progressFill');
    
    // 测试状态
    let isTesting = false;
    let testIndex = 0;
    let testStats = {
      success: 0,
      error: 0,
      total: 0
    };
    
    // 记录日志
    function log(message, type = 'info') {
      const logLine = `<span class="${type}">[${new Date().toLocaleTimeString()}] ${message}</span>\n`;
      result.innerHTML += logLine;
      result.scrollTop = result.scrollHeight;
    }
    
    // 更新统计
    function updateStats() {
      successCount.textContent = testStats.success;
      errorCount.textContent = testStats.error;
      totalCount.textContent = testStats.total;
    }
    
    // 更新进度
    function updateProgress(current, total) {
      const percentage = Math.round((current / total) * 100);
      progressFill.style.width = `${percentage}%`;
      progressFill.textContent = `${percentage}%`;
    }
    
    // 上传图片
    async function uploadImage(file) {
      try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch('http://localhost:8000/api/notes/upload/image', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          const data = await response.json();
          return data.url;
        } else {
          const errorData = await response.json().catch(() => ({ detail: '未知错误' }));
          throw new Error(`图片上传失败: ${errorData.detail || '请求失败'}`);
        }
      } catch (error) {
        console.error('图片上传错误:', error);
        throw error;
      }
    }
    
    // 模拟保存笔记
    async function saveNote(content) {
      try {
        const response = await fetch('http://localhost:8000/api/notes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title: '测试笔记',
            content: content,
            stockCode: '',
            stockName: ''
          })
        });
        
        if (response.ok) {
          return await response.json();
        } else {
          const errorData = await response.json().catch(() => ({ detail: '未知错误' }));
          throw new Error(`笔记保存失败: ${errorData.detail || '请求失败'}`);
        }
      } catch (error) {
        console.error('笔记保存错误:', error);
        throw error;
      }
    }
    
    // 测试单次编辑-保存
    async function runSingleTest(testNum) {
      try {
        let content = `# 测试笔记 ${testNum}\n\n这是第${testNum}次测试的内容`;
        
        // 如果包含图片，先上传图片
        if (includeImages.checked && testImage.files.length > 0) {
          log(`测试 ${testNum}: 开始上传图片...`, 'info');
          const imageUrl = await uploadImage(testImage.files[0]);
          log(`测试 ${testNum}: 图片上传成功 - URL: ${imageUrl}`, 'success');
          content += `\n\n![测试图片 ${testNum}](${imageUrl})`;
        }
        
        // 添加一些随机内容
        content += `\n\n时间: ${new Date().toLocaleString()}`;
        content += `\n随机数: ${Math.random().toFixed(6)}`;
        
        // 保存笔记
        log(`测试 ${testNum}: 开始保存笔记...`, 'info');
        const savedNote = await saveNote(content);
        log(`测试 ${testNum}: 笔记保存成功 - ID: ${savedNote.id}`, 'success');
        
        testStats.success++;
        return true;
      } catch (error) {
        log(`测试 ${testNum}: 失败 - ${error.message}`, 'error');
        testStats.error++;
        return false;
      } finally {
        testStats.total++;
        updateStats();
      }
    }
    
    // 开始测试
    async function startTesting() {
      isTesting = true;
      testIndex = 0;
      testStats = { success: 0, error: 0, total: 0 };
      
      const count = parseInt(testCount.value);
      const delay = parseInt(interval.value);
      
      // 禁用/启用按钮
      startTest.disabled = true;
      stopTest.disabled = false;
      
      log('开始批量编辑-保存测试...', 'info');
      
      try {
        for (testIndex = 1; testIndex <= count; testIndex++) {
          if (!isTesting) break;
          
          progressText.textContent = `正在进行测试 ${testIndex}/${count}...`;
          updateProgress(testIndex - 1, count);
          
          await runSingleTest(testIndex);
          
          if (testIndex < count) {
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
        
        if (isTesting) {
          progressText.textContent = '测试完成！';
          updateProgress(count, count);
          log(`测试完成: 共 ${count} 次，成功 ${testStats.success} 次，失败 ${testStats.error} 次`, 
               testStats.error === 0 ? 'success' : 'error');
        } else {
          progressText.textContent = '测试已停止';
          log(`测试已停止: 已完成 ${testIndex - 1}/${count} 次测试`, 'info');
        }
      } catch (error) {
        log(`测试过程中发生错误: ${error.message}`, 'error');
      } finally {
        isTesting = false;
        startTest.disabled = false;
        stopTest.disabled = true;
      }
    }
    
    // 停止测试
    function stopTesting() {
      isTesting = false;
    }
    
    // 清空结果
    function clearResults() {
      result.innerHTML = '';
      testStats = { success: 0, error: 0, total: 0 };
      updateStats();
      progressText.textContent = '准备开始测试...';
      updateProgress(0, 100);
      log('结果已清空，准备开始新的测试...', 'info');
    }
    
    // 事件监听
    startTest.addEventListener('click', startTesting);
    stopTest.addEventListener('click', stopTesting);
    clearResult.addEventListener('click', clearResults);
    
    // 初始化
    log('测试工具已准备就绪，请配置测试参数后开始测试...', 'info');
    updateStats();
  </script>
</body>
</html>